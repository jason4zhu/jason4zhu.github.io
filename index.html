<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dzhu.pro","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"right","width":300,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
<meta property="og:type" content="website">
<meta property="og:title" content="朱迪">
<meta property="og:url" content="https://dzhu.pro/index.html">
<meta property="og:site_name" content="朱迪">
<meta property="og:description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="朱迪">
<meta property="article:tag" content="dzhu">
<meta property="article:tag" content=" 朱迪">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dzhu.pro/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>朱迪</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">

  
<div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
  <a href="/" rel="section">
    <img class="site-author-image" itemprop="image" alt="朱迪" src="/images/avatar.jpg">
  </a>
  <a href="/" rel="section">
    <p class="site-author-name" itemprop="name">朱迪</p>
  </a>
  <div class="site-description" itemprop="description">Di Zhu, data architect, outdoor enthusiasts, introspectionist.</div>

  <div class="icon-wall" itemprop="icon-wall">
    <!-- 国家 -->
    <img class='icon-wall-icon' src="/images/icon_wall/cn.png" name="中国" desc="Where heart resides." />
    <img class='icon-wall-icon' src="/images/icon_wall/korea.png" name="韩国" desc="2006: 访学交流, the first time traveling abroad." />
    <img class='icon-wall-icon' src="/images/icon_wall/indonesia.png" name="印度尼西亚" desc="2014.10: Bali Island." />
    <img class='icon-wall-icon' src="/images/icon_wall/se.png" name="瑞典" desc="2015-2017: 生活、学习、工作，3年的快乐时光. Time flies." />
    <img class='icon-wall-icon' src="/images/icon_wall/norway.png" name="挪威" desc="2015: Traveling." />
    <img class='icon-wall-icon' src="/images/icon_wall/maldives.png" name="马尔代夫" desc="2016: Enjoying sunshine, snorkeling, and toning." />
    <img class='icon-wall-icon' src="/images/icon_wall/uae.png" name="阿联酋" desc="2017: 1年时间，辗转于冰与火的两个国度。Work hard, play hard." />
    <img class='icon-wall-icon' src="/images/icon_wall/germany.png" name="德国" desc="2017: Traveling." />
    <img class='icon-wall-icon' src="/images/icon_wall/thailand.png" name="泰国" desc="2017: Traveling." />
    <img class='icon-wall-icon' src="/images/icon_wall/oman.png" name="阿曼" desc="2017: 海上攀岩。头顶中东烈日，手握刀削岩壁，脚下巨浪翻滚。It's utterly a daunting challenge to inner self LOL." />
    <img class='icon-wall-icon' src="/images/icon_wall/jp.png" name="日本" desc="2020: Heading for skiing in Hakuba Valley." />
    <!-- 城市 -->
    <img class='icon-wall-icon' src="/images/icon_wall/xixishidi.png" name="杭州" desc="2013-2014: Living outside BJ alone the first time." />
    <img class='icon-wall-icon' src="/images/icon_wall/stockholm.png" name="斯德哥尔摩" desc="2015-2017: 生活、学习、工作，3年的快乐时光. Time flies." />
    <img class='icon-wall-icon' src="/images/icon_wall/marina_dubai.png" name="迪拜" desc="2017 Marina: The life between ocean and desert." />
    <!-- 学校相关 -->
    <img class='icon-wall-icon' src="/images/icon_wall/bhsf.png" name="北京四中" desc="2006-2009: Where the story begins." />
    <img class='icon-wall-icon' src="/images/icon_wall/pku.png" name="北京大学" desc="2009-2013: Computer Science, B.S." />
    <img class='icon-wall-icon' src="/images/icon_wall/kth.png" name="瑞典皇家理工学院" desc="2015-2017: Distributed Systems of Software Engineering, M.E." />
    <img class='icon-wall-icon' src="/images/icon_wall/kth_cssa.png" name="KTH-CSSA" desc="2016-2017: 学生会主席，参与负责组织2场500人+春晚活动。" />
    <!-- 公司相关 -->
    <img class='icon-wall-icon' src="/images/icon_wall/alibaba.png" name="阿里巴巴" desc="2013-2014: First job as an undergraduate." />
    <img class='icon-wall-icon' src="/images/icon_wall/miaozhen_systems.png" name="秒针系统" desc="2014-2015: Second job." />
    <img class='icon-wall-icon' src="/images/icon_wall/sqore.png" name="Sqore" desc="2015-2017: Part-time job along with the study in Stockholm." />
    <img class='icon-wall-icon' src="/images/icon_wall/salesforce.png" name="Salesforce" desc="2016: Internship in Stockholm during summer vacation." />
    <img class='icon-wall-icon' src="/images/icon_wall/careem.png" name="Careem" desc="2017: My third job, which have made my memories of the time leading life in Dubai." />
    <img class='icon-wall-icon' src="/images/icon_wall/kuaishou.png" name="快手" desc="[2018, ∞) Where I am now." />
    <!-- 爱好 -->
    <!-- kayaking
  ski
  horse riding
  paddle boarding
  rock climbing
  Rock climbing over the sea
  gym
  jogging
  diving（浮潜）
  Spartan
  五子棋（Renju）
  oil painting(油画)
  台球
  Archery（射箭） -->
    <!-- 寺庙/introspection -->
    <!-- <img class='icon-wall-icon' src="/images/icon_wall/lingyinsi.png" name="灵隐寺" desc="2014, 2016." /> -->
    <!-- <img class='icon-wall-icon' src="/images/icon_wall/grand_mosque.png" name="阿布扎比·大清真寺" desc="2017." /> -->
    <!-- 大觉寺（动静等观）
  曼谷·大皇宫和Wat Phra Kaeo玉佛寺
  长野，信州，善光寺
  乌兰布统的喇嘛庙（阿贵庙） -->
    <!-- 有纪念意义的景点 -->
    <!-- <img class='icon-wall-icon' src="/images/icon_wall/rovaniemi.png" name="圣诞老人村" desc="2015: 洛瓦涅米." /> -->
    <!-- <img class='icon-wall-icon' src="/images/icon_wall/are.png" name="Åre" desc="2015: 瑞典最大滑雪胜地。第一次感受到滑雪的魅力：世之奇伟、瑰怪、非常之观，常在于险远，而人之所罕至焉." /> -->
    <!-- <img class='icon-wall-icon' src="/images/icon_wall/chamonix.png" name="Chamonix" desc="2016: Skiers 'Holy Land': Mont Blanc, located in the Alps, the highest peak in Europe. #Skiing-In-The-Postcard#" /> -->
    <!-- uppsala
  hakuba valley
  乌兰布统，赤峰
  太仆寺旗
  乌兰察布，火山口
  草原天路
  雾灵山
  张北，骑马 -->
  
  </div>

</div>



      

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <!--<div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">朱迪</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>-->

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Footprints</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="c_index_page"></div>

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dzhu.pro/2020/03/28/CoreJava_Map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱迪">
      <meta itemprop="description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱迪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/28/CoreJava_Map/" class="post-title-link" itemprop="url">CoreJava系列：Map</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-28 21:58:00 / 修改时间：22:02:15" itemprop="dateCreated datePublished" datetime="2020-03-28T21:58:00+08:00">2020-03-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>拉链法，哈希取模（hash+mod）确定元素被放置的数组下标。一般数组长度限制为2^n，这样做的好处：<code>hash(x) % arr.length</code>可以被优化为<code>hash(x) &amp; (arr.length-1)</code>，显著提升取模计算效率</p>

<script type="text/javascript" src="/js/kity204.min.js"></script>
<script type="text/javascript" src="/js/kityminder1450.core.min.js"></script>
<script defer="true" type="text/javascript" src="/js/mindmap020.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/mindmap020.min.css">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dzhu.pro/2020/03/25/CoreJava_Queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱迪">
      <meta itemprop="description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱迪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/25/CoreJava_Queue/" class="post-title-link" itemprop="url">CoreJava系列：Queue</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-25 18:12:00" itemprop="dateCreated datePublished" datetime="2020-03-25T18:12:00+08:00">2020-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-28 21:59:49" itemprop="dateModified" datetime="2020-03-28T21:59:49+08:00">2020-03-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote class="pullquote mindmap mindmap-md"><ul>
<li>Java队列<ul>
<li>源码阅读<ul>
<li>Queue</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>

<h1 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h1><ul>
<li><p><code>DelayedWorkQueue</code></p>
<ul>
<li>只服务于<code>ScheduledThreadPoolExecutor</code> [TODO 内链]、基于最小堆实现的、结合<code>DelayQueue</code>和<code>PriorityQueue</code>两种队列特性的<code>BlockingQueue</code></li>
<li>特殊feature：<ul>
<li>堆中记录部分task类型为<code>ScheduledFutureTask</code>，此对象中存储了heapIndex（所在堆数组的位置下标）。在cancel task时，可以将（查找task、移除task）两步操作的的复杂度从O(N)降至O(logN）<ul>
<li>查找task为O(1), 但如果task类型不为<code>ScheduledFutureTask</code>, 则降级为O(N)</li>
<li>移除task为堆的标准siftUp, siftDown操作，复杂度O(logN)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>Deque</code></p>
</li>
<li><p><code>LinkedBlockingDeque</code></p>
</li>
</ul>

<script type="text/javascript" src="/js/kity204.min.js"></script>
<script type="text/javascript" src="/js/kityminder1450.core.min.js"></script>
<script defer="true" type="text/javascript" src="/js/mindmap020.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/mindmap020.min.css">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dzhu.pro/2020/03/22/CoreJava_Thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱迪">
      <meta itemprop="description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱迪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/22/CoreJava_Thread/" class="post-title-link" itemprop="url">CoreJava系列：多线程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-22 10:30:00" itemprop="dateCreated datePublished" datetime="2020-03-22T10:30:00+08:00">2020-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-30 10:48:52" itemprop="dateModified" datetime="2020-03-30T10:48:52+08:00">2020-03-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote class="pullquote mindmap mindmap-md"><ul>
<li>Java多线程<ul>
<li>源码阅读<ul>
<li>Thread基础类</li>
<li>Executor相关</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>


<h1 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h1><h2 id="多线程并发基础对象"><a href="#多线程并发基础对象" class="headerlink" title="多线程并发基础对象"></a>多线程并发基础对象</h2><h3 id="核心类关系图"><a href="#核心类关系图" class="headerlink" title="核心类关系图"></a>核心类关系图</h3><h4 id="Runnable相关"><a href="#Runnable相关" class="headerlink" title="Runnable相关"></a>Runnable相关</h4><p><img src="/images/post_image/hierarchy_runnable.png" alt="hierarchy_runnable"></p>
<h4 id="Callable相关"><a href="#Callable相关" class="headerlink" title="Callable相关"></a>Callable相关</h4><p><img src="/images/post_image/hierarchy_callable.png" alt="hierarchy_callable"></p>
<h4 id="Future相关"><a href="#Future相关" class="headerlink" title="Future相关"></a>Future相关</h4><p><img src="/images/post_image/hierarchy_future.png" alt="hierarchy_future"></p>
<h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><h4 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h4><ul>
<li><strong>功能</strong>：线程最核心、基础类</li>
<li><strong>特点</strong>：<ul>
<li>基础并发类（JDK1.4以前即存在，属于<code>java.lang.*</code>包）</li>
<li>继承自<code>Runnable</code>接口</li>
</ul>
</li>
<li><strong>属性</strong>：<ul>
<li>name<ul>
<li>线程名称（名字可重复，不强制唯一）</li>
</ul>
</li>
<li>priority<ul>
<li>线程优先级，最高10，最低1；优先级越高，更优先获取计算资源</li>
<li>子线程优先级默认继承父线程优先级</li>
</ul>
</li>
<li><a href="#ThreadGroup">ThreadGroup</a><ul>
<li><a href="#ThreadGroup">线程组</a>，默认继承父线程ThreadGroup信息</li>
</ul>
</li>
<li>daemon<ul>
<li>守护线程，默认低优先级，在后台独立运行（eg. GC线程）</li>
<li>如果non-daemon线程都运行结束，则无论是否还有daemon线程运行，JVM都会终止</li>
<li>子线程daemon属性默认继承父线程daemon属性</li>
</ul>
</li>
<li><a href="#ThreadLocal">ThreadLocalMap</a><a name="anchor_java_thread_threadlocal"></a><ul>
<li>每个线程均有属于当前线程的<code>ThreadLocalMap</code>对象，用于存储线程范围内的KVs对象</li>
<li>一个线程中存在两个<code>ThreadLocalMap</code>对象：threadLocals，和inheritableThreadLocals<ul>
<li>前者在线程创建时初始化成一个空Map</li>
<li>后者在线程创建时继承父线程inheritableThreadLocals变量中全部KVs对象</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>使用的两种方式</strong>：<ol>
<li>继承<code>Thread</code>类，复写<code>run</code>方法</li>
<li>实现<code>Runnable</code>接口，初始化Thread对象时传入刚刚创建的<code>Runnable</code>实例</li>
</ol>
</li>
<li><strong>线程状态</strong>：<ul>
<li><strong>声明位置</strong>：<ul>
<li><code>Thread.State</code>内部类</li>
</ul>
</li>
<li><strong>状态值</strong>：<ul>
<li>NEW<ul>
<li>还没有调用<code>start()</code>方法的、新创建的Thread对象</li>
</ul>
</li>
<li>RUNNABLE<ul>
<li>运行状态的Thread，可能会不定时在操作系统层获取/释放CPU时间分片</li>
</ul>
</li>
<li>BLOCKED<ul>
<li>线程执行到某步，等到获得锁（monitor lock）</li>
</ul>
</li>
<li>WAITING<ul>
<li>线程中调用了<code>join()</code>, <code>wait()</code>方法</li>
</ul>
</li>
<li>TIMED_WAITING<ul>
<li>线程中调用了<code>sleep(time)</code>, <code>join(timeout)</code>, <code>wait(timeout)</code>方法</li>
</ul>
</li>
<li>TERMINATED<ul>
<li>线程运行完成，已结束</li>
</ul>
</li>
</ul>
</li>
<li><strong>线程状态转换FSM</strong>：<ul>
<li><strong>Java线程状态</strong>：<ul>
<li><img src="/images/post_image/java_thread_state_FSM.jpeg" alt="thread_state_FSM"></li>
</ul>
</li>
<li><strong>操作系统线程状态</strong>：<ul>
<li><img src="/images/post_image/system_thread_state_FSM.jpeg" alt="thread_state_FSM"></li>
</ul>
</li>
<li><strong>差异点</strong>：<ol>
<li>操作系统级线程的ready和running两个状态，在Java线程状态中被封装为统一的RUNNABLE状态，底层CPU时间分片的分发对上层Java应用透明</li>
<li>操作系统中，粗粒度的waiting状态，在Java中被细分为WAITING，TIMED_WAITING，和BLOCKED三个由不同原因触发的等待状态</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ThreadGroup"><a href="#ThreadGroup" class="headerlink" title="ThreadGroup"></a>ThreadGroup</h4><ul>
<li><strong>功能</strong>：线程组，表示一系列线程的集合</li>
<li><strong>特点</strong>：<ul>
<li>基础并发类（JDK1.4以前即存在，属于<code>java.lang.*</code>包）</li>
<li>子节点可为线程，也可为其他的线程组（形成一棵树结构：除初始化的线程组之外，所有线程和线程组均有父节点）</li>
<li>新创建的线程组，默认使用当前线程所在线程组，作为父节点</li>
</ul>
</li>
<li><strong>Java初始状态的线程组</strong>：<ul>
<li>根线程组：<strong>system</strong>线程组。用来处理JVM系统任务的线程组，e.g. 对象的销毁等</li>
<li>system线程组的直接子线程组：<strong>main</strong>线程组。此线程组至少包含一个main线程，用于执行main方法</li>
<li>main线程组的子线程组均来自于用户程序后续的自行创建</li>
<li><img src="/images/post_image/hierarchy_threadgroup.png" alt="hierarchy_threadgroup"></li>
</ul>
</li>
</ul>
<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h4><ul>
<li><strong>功能</strong>：提供thread-local级别的变量存储，每个线程在调用<code>ThreadLocal.get/set</code>方法时，获取到的对象都是线程独有的</li>
<li><strong>特点</strong>：<ul>
<li>基础并发类（JDK1.4以前即存在，属于<code>java.lang.*</code>包）</li>
</ul>
</li>
<li><strong>实现原理</strong>：<ul>
<li><strong><code>ThreadLocal.get</code>方法举例（set方法类似）</strong><ul>
<li>每个<a href="#anchor_java_thread_threadlocal">线程内部都存在私有的<code>ThreadLocalMap</code>对象</a>: threadLocals（访问控制级别为default，相同package内的类均可以直接访问）</li>
<li>在调用<code>ThreadLocal.get</code>方法时，会直接调用<code>Thread.currentThread().threadLocals</code>，拿到当前线程对应的<code>ThreadLocalMap</code>对象</li>
<li><code>ThreadLocalMap</code>对象为自定义的hashmap封装，负责KV存储，key为<code>ThreadLocal</code>实例，value为当前<code>ThreadLocal</code>产出的线程独有的对象</li>
</ul>
</li>
<li><strong>总结</strong>：<ul>
<li>每个线程都有独享的<code>ThreadLocalMap</code>内部变量，用于KV存储。Key为ThreadLocal实例，Value为对应的ThreadLocal封装的对象</li>
<li>对于同一个<code>ThreadLocal</code>实例，会以Key的形式存在于多个线程的多个<code>ThreadLocalMap</code>里</li>
</ul>
</li>
</ul>
</li>
<li><strong>示例</strong>：<ul>
<li>为每个线程提供unique ID的实现类（不同线程获取到的ID一定不同，同一个线程多次获取到的ID相同）：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadId</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Atomic integer containing the next thread ID to be assigned</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextId = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">	<span class="comment">// Thread local variable containing each thread's ID</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; threadId =</span><br><span class="line">		<span class="keyword">new</span> ThreadLocal&lt;Integer&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> nextId.getAndIncrement();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">// Returns the current thread's unique ID, assigning it if necessary</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> threadId.get();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong>高级设计细节</strong><ul>
<li><strong>ThreadLocalMap.Entry为何声明为WeakReference</strong><ul>
<li><strong>实现</strong><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">	Object value;</span><br><span class="line">	Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">		<span class="keyword">super</span>(k);</span><br><span class="line">		value = v;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>解释</strong><ul>
<li>将对应的key（<code>ThreadLocal</code>对象）声明为弱引用。也即，ThreadLocal对象在没有任何强引用之后，即使有弱引用，也会被下次的gc回收</li>
<li>对于上述示例，如果将<code>threadId</code>变量置为null，则残留在各个线程内部变量<code>ThreadLocalMap</code>中的、以<code>threadId</code>为key的项，都变为了stale entry，需要被及时清理。如果此处为强引用，则由于部分线程的<code>ThreadLocalMap</code>中还有对<code>threadId</code>的引用，导致内存泄漏</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h4><ul>
<li><strong>功能</strong>：实现此接口的类，对应的实例可以被线程执行</li>
<li><strong>特点</strong>：<ul>
<li>基础并发类（JDK1.4以前即存在，属于<code>java.lang.*</code>包）</li>
<li>接口核心方法 <code>void run()</code>：<ul>
<li>线程开始执行的逻辑入口。无传参，没有返回值，不可抛Exception异常</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h4><ul>
<li><strong>功能</strong>：与<a href="#Runnable">Runnable</a>接口相同</li>
<li><strong>特点</strong>：<ul>
<li>拓展并发类（JDK1.5以后增加，属于<code>java.util.concurrent.*</code>包）</li>
<li>接口核心方法 <code>void call()</code>：<ul>
<li>线程开始执行的逻辑入口</li>
<li>与Runnable的相同点：无传参</li>
<li>与Runnable的不同点：<ul>
<li>有返回值</li>
<li>可以抛Exception异常（使异常可以上抛，被调用者catch住，并做相应处理。而不是只能在<code>Runnable.run</code>方法内部处理）</li>
<li>通过返回的Future对象，可以在线程异步执行过程中主动使用、管理cancel中断</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Runnable对象适配成Callable的实现方式</strong>：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> &lt;<span class="title">T</span>&gt; <span class="title">RunnableAdapter</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Runnable task;</span><br><span class="line">	<span class="keyword">final</span> T result;</span><br><span class="line">	RunnableAdapter(Runnable task, T result) &#123;</span><br><span class="line">		<span class="keyword">this</span>.task = task;</span><br><span class="line">		<span class="keyword">this</span>.result = result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		task.run();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h4><ul>
<li><strong>功能</strong>：代表异步执行逻辑返回结果的接口</li>
<li><strong>特点</strong>：<ul>
<li>拓展并发类（JDK1.5以后增加，属于<code>java.util.concurrent.*</code>包）</li>
</ul>
</li>
<li><strong>核心方法</strong>：<ul>
<li><code>isDone()</code> | <code>isCancelled()</code><ul>
<li>检查异步执行逻辑当前状态（已完成 or 被终止）</li>
<li>对于<code>isDone</code>, 正常执行结束、被中断、抛异常等，均属于已完成</li>
</ul>
</li>
<li><code>get()</code><ul>
<li>block等待、获取异步执行逻辑返回结果（可无限等待，或设置timeout）</li>
</ul>
</li>
<li><code>cancel()</code><ul>
<li>中断、取消当前的异步执行逻辑<ul>
<li>如果执行线程已完成，或已被中断，则调用<code>cancel</code>失败</li>
<li>如果作业尚未启动，则调用<code>cancel</code>后作业不会再启动</li>
<li>如果作业在运行中，调用<code>cancel</code>后会根据mayInterruptIfRunning参数，决定是否interrupt执行线程</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="RunnableFuture"><a href="#RunnableFuture" class="headerlink" title="RunnableFuture"></a>RunnableFuture</h4><ul>
<li><strong>功能</strong>：一个继承了<a href="#Runnable">Runnable</a>和<a href="#Future">Future</a>的组合接口。执行完<code>Runnable.run</code>方法后，可以通过自身Future属性拿到异步执行逻辑的返回值</li>
<li><strong>特点</strong>：<ul>
<li>拓展并发类（JDK1.5以后增加，属于<code>java.util.concurrent.*</code>包）</li>
<li>优点：通过一个<code>RunnableFuture</code>实例，既可以实现异步执行逻辑，又能够管理异步执行过程（获得线程状态，获取异步执行结果等）。无需分别创建<code>Runnable</code>/<code>Callable</code>实例，在执行后获得返回的<code>Future</code>实例（一共两个对象）来管理异步执行整体生命周期<ul>
<li>示例<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// One instance for implementing execution logic</span></span><br><span class="line">CallableImpl impl = <span class="keyword">new</span> CallableImpl();</span><br><span class="line">FutureTask&lt;String&gt; future = <span class="keyword">new</span> FutureTask&lt;String&gt;(impl);</span><br><span class="line">executor.execute(future);</span><br><span class="line"><span class="comment">// Another instance for retrieving result</span></span><br><span class="line">String result = future.get();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><strong>核心实现类</strong>：<a href="#FutureTask">FutureTask</a></li>
</ul>
<h4 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h4><ul>
<li><strong>功能</strong>：<a href="#RunnableFuture">RunnableFuture</a>最直接的核心实现类。同时兼顾<code>Runnable</code>和<code>Future</code>特性，实现异步执行整体生命周期的高内聚管理</li>
<li><strong>特点</strong>：<ul>
<li>拓展并发类（JDK1.5以后增加，属于<code>java.util.concurrent.*</code>包）</li>
</ul>
</li>
<li><strong>高级设计细节</strong>：<ul>
<li>通过<code>state</code>状态字段，配合volatile+CAS更新操作，进行同步控制（内部状态转移）</li>
<li>Treiber Stack<ul>
<li>目的：实现线程安全的lock-free（乐观锁）stack</li>
<li>实现：通过CAS操作实现push、pop操作</li>
<li>示例：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentStack</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; top = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(E elem)</span> </span>&#123;</span><br><span class="line">		Node&lt;E&gt; newHead = <span class="keyword">new</span> Node&lt;&gt;(elem);</span><br><span class="line">		Node&lt;E&gt; oldHead;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			oldHead = top.get();</span><br><span class="line">			newHead.next = oldHead;</span><br><span class="line">		&#125; <span class="keyword">while</span> (!top.compareAndSet(oldHead, newHead));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> E <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Node&lt;E&gt; oldHead;</span><br><span class="line">		Node&lt;E&gt; newHead;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			oldHead = top.get();</span><br><span class="line">			<span class="keyword">if</span> (oldHead == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			newHead = oldHead.next;</span><br><span class="line">		&#125; <span class="keyword">while</span> (!top.compareAndSet(oldHead, newHead));</span><br><span class="line">		<span class="keyword">return</span> oldHead.item;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>ABA问题：<ul>
<li>对于没有垃圾回收的语言，Treiber stack可能会面临ABA问题</li>
<li>在Java中，Runtime提供了如下保证：新创建的对象引用不可能与任何其他可到达的对象引用相同</li>
<li>对于上述示例，<code>compareAndSet</code>中的oldHead引用，不会与其他线程新创建的对象引用相同（即使oldHead引用和新创建的对象引用指向同一个对象，但引用也是不同的），所以不会出现ABA问题</li>
</ul>
</li>
<li>在FutureTask中的应用：<code>WaitNode</code><ul>
<li>代码：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNode</span> </span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> Thread thread;</span><br><span class="line">	<span class="keyword">volatile</span> WaitNode next;</span><br><span class="line">	WaitNode() &#123; thread = Thread.currentThread(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>解释：<ul>
<li>形成一个值为Thread对象的单项链表（当做Stack来使用），表示所有等待任务执行完毕的线程集合</li>
<li>任何线程调用<code>FutureTask.get()</code>方法后，都会记录到<code>WaitNode</code>中，异步逻辑执行结束时刻依次唤醒各等待线程</li>
</ul>
</li>
</ul>
</li>
<li>其他应用场景：<code>Phaser</code>, <code>SynchronousQueue</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ScheduledFutureTask"><a href="#ScheduledFutureTask" class="headerlink" title="ScheduledFutureTask"></a>ScheduledFutureTask</h4><ul>
<li><strong>功能</strong>：</li>
<li><strong>特点</strong>：<ul>
<li>拓展并发类（JDK1.5以后增加，属于<code>java.util.concurrent.*</code>包）</li>
</ul>
</li>
</ul>
<p>[TODO 放到ScheduledThreadPoolExecutor里]</p>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li>多异步作业下，通过复用线程提升效率（reduce per-task invocation overhead）</li>
<li>更有效地管理计算资源、提供统计数据等</li>
</ul>
<h3 id="核心类关系图-1"><a href="#核心类关系图-1" class="headerlink" title="核心类关系图"></a>核心类关系图</h3><p><img src="/images/post_image/hierarchy_executor.png" alt="hierarchy_executor"></p>
<h3 id="核心类-1"><a href="#核心类-1" class="headerlink" title="核心类"></a>核心类</h3><h4 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h4><ul>
<li><strong>功能</strong>：An object that executes submitted <code>Runnable</code> tasks</li>
<li><strong>目的</strong>：provides a way of decoupling task submission from the mechanics of how each task will be run, including details of thread use, scheduling, etc.</li>
<li><strong>唯一方法</strong>：<code>void execute(Runnable command)</code></li>
<li><strong>核心子接口</strong>：<code>ExecutorService</code></li>
</ul>
<h4 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h4><ul>
<li><strong>功能</strong>：更丰富的<code>Executor</code>继承接口</li>
<li><strong>核心方法</strong>：<ul>
<li><strong>单task执行</strong><ul>
<li><code>submit</code>（增强版<code>Executor.execute</code>）<ul>
<li>额外提供<code>Future</code>返回值。可用于终止作业、得到作业返回值</li>
<li>除<code>Runnable</code>对象外，同时接纳<code>Callable</code>对象</li>
<li>对于<code>Future&lt;T&gt; submit(Runnable task, T result)</code>，只是在task运行结束后，将result原封不动地封装到Future对象中</li>
</ul>
</li>
</ul>
</li>
<li><strong>批量执行</strong><ul>
<li><code>invokeAll</code>: 批量执行全部task，目标是全部完成时，返回全部<code>Future</code>（调用过程中不可修改task列表）</li>
<li><code>invokeAny</code>: 批量执行全部task，目标是完成任意一个task时，返回对应的<code>Future</code>（其他task会被cancel）（调用过程中不可修改task列表）</li>
</ul>
</li>
<li><strong>Executor终止</strong><ul>
<li><code>shutdown</code>:  队列中作业可继续执行完成（但此方法不会等待，需要等待的话调用<code>awaitTermination</code>），不接受新的提交</li>
<li><code>awaitTermination</code>: 调用<code>shutdown</code>后，等待全部作业执行完成（带timeout）</li>
<li><code>shutdownNow</code>: 队列中作业不会执行，正在执行中的作业尝试调用<code>Thread.interrupt</code>终止</li>
<li>终止完成时刻保证：无运行中task、无等待执行task、没有新的task可以被提交</li>
</ul>
</li>
</ul>
</li>
<li><strong>工厂类</strong>：<code>Executors</code></li>
</ul>
<h4 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h4><ul>
<li><strong>功能</strong>：线程池最常用、核心的实现类</li>
<li><strong>构造器核心参数</strong><ul>
<li><strong>int corePoolSize</strong><ul>
<li>最少会保留的idle thread数量（用完后也不销毁）</li>
</ul>
</li>
<li><strong>int maximumPoolSize</strong><ul>
<li>最大thread数量（超过此线程承载量的task会保存到workQueue里等待执行）</li>
</ul>
</li>
<li><strong>long keepAliveTime + TimeUnit unit</strong><ul>
<li>当线程池中线程数量大于corePoolSize时，线程最多等待keepAliveTime时间，如果还没有被利用上，则销毁</li>
<li>如果调用<code>allowCoreThreadTimeOut</code>方法，则corePoolThread一样会被回收</li>
</ul>
</li>
<li><strong>BlockingQueue<Runnable> workQueue</strong><ul>
<li>当maximumPoolSize个线程都被占用时，再提交的task会放到workQueue里排队等待</li>
</ul>
</li>
<li><strong>ThreadFactory threadFactory</strong><ul>
<li>线程构建工厂（包装<code>new Thread()</code>，同时可以修改初始化Thread的策略，e.g. 线程名, daemon, priority, <code>ThreadGroup</code>等）</li>
</ul>
</li>
<li><strong>RejectedExecutionHandler handler</strong><ul>
<li><strong>触发条件</strong><ul>
<li>当线程池中的线程全部被占用，且workQueue已满时，再提交task会进入此handler</li>
<li><code>ExecutorService</code>在shutdown过程中，再提交task也会进入此handler</li>
</ul>
</li>
<li><strong>策略</strong><ul>
<li><code>AbortPolicy</code>: 默认策略，直接抛异常</li>
<li><code>CallerRunsPolicy</code>: 调用<code>ExecutorService.execute(task)</code>方法的线程执行task（反压限流）</li>
<li><code>DiscardPolicy</code>: 直接丢弃，drop-silently</li>
<li><code>DiscardOldestPolicy</code>: 优先丢弃workQueue头部task，继续尝试执行task，循环此过程直到execute成功</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>核心参数与线程数、task数的动态关系</strong><ul>
<li>定义：当前线程池中线程数：n</li>
<li><strong>n &lt; corePoolSize</strong>:<ul>
<li>一个新task被提交时，即使n个线程都处于idle状态，也会创建新线程执行此task</li>
</ul>
</li>
<li><strong>corePoolSize &lt;= n &lt; maximumPoolSize</strong><ul>
<li>优先放入BlockingQueue中，只有在队列满了之后，才会尝试创建新线程（如果此时队列已满、且n==maximumPoolSize，则task会被拒绝）</li>
</ul>
</li>
</ul>
</li>
<li><strong>队列排队3种方式</strong><ul>
<li><strong>Direct handoffs</strong><ul>
<li><code>SynchronousQueue</code>, 每一个task插入操作必须有一个对应的移除操作（线程接管）</li>
</ul>
</li>
<li><strong>Unbounded queues</strong><ul>
<li><code>LinkedBlockingQueue</code>, 队列无上限</li>
</ul>
</li>
<li><strong>Bounded queues</strong><ul>
<li><code>ArrayBlockingQueue</code>, 队列有上限</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ScheduledThreadPoolExecutor"><a href="#ScheduledThreadPoolExecutor" class="headerlink" title="ScheduledThreadPoolExecutor"></a>ScheduledThreadPoolExecutor</h4><ul>
<li><strong>功能</strong>：可以延迟执行，或者周期性执行task的<code>ThreadPoolExecutor</code><ul>
<li>延迟作业(Delayed task)只能保证no-sooner-than语义，不能保证exactly-at-specific-time</li>
<li>corePoolSize不要设为0，<code>allowCoreThreadTimeOut</code>不要设为true。由于周期性调度完会将task放回queue中，其表现为一个（永远有等待task的队列+有corePoolSize线程）的线程池，所以maximumPoolSize参数不会起到任何效果</li>
</ul>
</li>
<li><strong>构造器核心参数</strong><ul>
<li>与<code>ThreadPoolExecutor</code>参数一致，两个不同点：<ol>
<li>workQueue固定为<code>DelayedWorkQueue</code> [TODO 内链]</li>
<li>不再需要设置<code>maximumPoolSize</code>（同理，不再有<code>long keepAliveTime</code>和<code>TimeUnit unit</code>）</li>
</ol>
</li>
</ul>
</li>
<li><strong>核心方法</strong><ul>
<li>延迟执行<ul>
<li><code>schedule</code></li>
</ul>
</li>
<li>周期性执行<ul>
<li><code>scheduleAtFixedRate</code><ul>
<li>间隔相同period时间执行task（period: 当前task启动时刻与下一次task启动时刻间隔）</li>
<li>如果task运行时间大于period，则下一个task会等待前者完成后再调度，不会重叠调度</li>
<li>如果执行某次task抛异常，则后续调度直接停止调度</li>
</ul>
</li>
<li><code>scheduleWithFixedDelay</code><ul>
<li>间隔相同delay时间执行task（delay: 当前task结束时刻与下一次task启动时刻间隔）</li>
<li>如果执行某次task抛异常，则后续调度直接停止调度</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h4><ul>
<li><strong>功能</strong>：用来执行<code>ForkJoinTask</code>的专用线程池</li>
<li><strong>核心feature</strong><ul>
<li><strong>适用于fork-and-join并发编程模型</strong>：并行实现分治算法（Divide-and-Conquer）</li>
<li><strong>work-stealing思想</strong>：<code>ForkJoinPool</code>为线程池中每个线程（<code>ForkJoinWorkerThread</code>）都分配了一个专属<code>WorkQueue</code>。每个线程会尽最大可能发现并执行自己队列中的task，如果空闲（eg. 等待子任务的join操作），则会尝试从其他线程的队列中steal task来完成，充分提高并发效率<ul>
<li><strong>核心逻辑实现类</strong>：<code>WorkQueue</code>：采用双端队列（Deques, 类似<code>LinkedBlockingDeque</code>。在<code>WorkQueue</code>中使用了<code>ForkJoinTask</code>数组），维护BASE和TOP指针，获取过程通过CAS操作（<code>Unsafe.*</code>）保证多线程下的一致性</li>
<li><strong>三个核心操作</strong>：push, pop, poll（a.k.a. steal）<ul>
<li>push和pop只允许从当前队列所属线程调用，均在栈顶（TOP）操作，符合LIFO原则</li>
<li>poll可以从其他线程调用（steal），均在栈底（BASE）操作，符合FIFO原则</li>
</ul>
</li>
<li><strong>核心策略</strong>：<ol>
<li>task通过fork生成的subtasks只能通过push入栈，插入当前task所属工作线程的队列，当线程空闲后通过pop拉取当前队列待执行的task（LIFO）</li>
<li>工作线程空闲，且工作线程拥有的队列也没有待执行的task时，会从其他工作线程所属队列通过poll方法steal任务来执行（FIFO，oldest-first）</li>
<li>遇到join方法时，当前线程并不会阻塞等待子任务的完成，而是尝试执行其他任务（本地或者steal），等到join结束后主动notify线程继续推进此任务</li>
</ol>
</li>
<li><strong>策略优势</strong>：<ol>
<li>减少stealer和owner从同一个队列获取task的冲突可能性</li>
<li>充分利用“越大的作业，越可能在队列栈底”这个前提，使得被steal的作业大概率是个big-unit-of-work, 从而能进一步在stealer端被分解执行</li>
</ol>
</li>
<li><strong>图示</strong>：<ul>
<li><img src="/images/post_image/forkjoinpool_work_stealing_procedure.png" alt="forkjoinpool_work_stealing_procedure"></li>
</ul>
</li>
</ul>
</li>
<li><strong>通用<code>ForkJoinPool</code>实例</strong>：<ul>
<li>jdk8中，<code>ForkJoinPool</code>提供了默认的commonPool，用来处理没有被显式提交到任何线程池的任务（e.g. java stream API的自动并行化：<code>List.parallelStream().forEach(out::println)</code>）</li>
</ul>
</li>
</ul>
</li>
<li><strong>数据结构</strong><ul>
<li><strong><code>ForkJoinPool</code>：</strong>绑定一个<code>WorkQueue[]</code>数组</li>
<li><strong><code>WorkQueue</code>：</strong>绑定所属<code>ForkJoinPool</code>实例；关联一个<code>ForkJoinWorkerThread</code>工作线程；以及<code>ForkJoinTask[]</code>数组，作为任务队列</li>
<li><strong><code>ForkJoinWorkerThread</code>：</strong>反向关联所属<code>ForkJoinPool</code>，以及所属的<code>WorkQueue</code></li>
</ul>
</li>
<li><strong>构造器核心参数</strong><ul>
<li><strong>int parallelism</strong>：当前线程池并发度，默认等于处理器数</li>
<li><strong>ForkJoinWorkerThreadFactory factory</strong>：<code>ForkJoinWorkerThread</code>线程工厂类</li>
<li><strong>UncaughtExceptionHandler handler</strong>：工作线程遇到不可恢复错误时的处理器</li>
<li><strong>boolean asyncMode</strong>：如果为true, 线程内处理本地队列的task顺序为FIFO（更像消息队列）；如果为false，则处理顺序为LIFO（更符合fork-join模型，处理递归式任务）</li>
</ul>
</li>
<li><strong>task类型</strong><ul>
<li><strong>基类</strong>：<code>ForkJoinTask</code></li>
<li><strong>子类</strong>：<ul>
<li><code>RecursiveAction</code>: 不返回任何结果的task（只为执行一个动作）</li>
<li><code>RecursiveTask</code>: 返回某个结果的task</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h4><p>[TODO ]<br>固定线程数的线程池：newFixedThreadPool<br>单个线程的线程池：newSingleThreadExecutor<br>可缓存的线程池：newCachedThreadPool<br>可延时/周期调度的线程池：newScheduledThreadPool<br>Fork/Join线程池：newWorkStealingPool，在Java 1.7时才引入，其核心实现就是ForkJoinPool类</p>
<h2 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h2><ul>
<li>synchronized</li>
<li>volatile</li>
<li><code>ReentrantLock</code> &amp;&amp; <code>Condition</code> [TODO evernote知识点]<ul>
<li><a href="https://www.baeldung.com/java-concurrent-locks" target="_blank" rel="noopener">https://www.baeldung.com/java-concurrent-locks</a></li>
<li><a href="https://www.zoftino.com/java-concurrency-lock-and-condition-examples" target="_blank" rel="noopener">https://www.zoftino.com/java-concurrency-lock-and-condition-examples</a></li>
</ul>
</li>
<li>AQS：<code>AbstractQueuedSynchronizer</code><ul>
<li>TODO：evernote知识点</li>
<li>TODO：<a href="https://segmentfault.com/a/1190000015739343" target="_blank" rel="noopener">https://segmentfault.com/a/1190000015739343</a></li>
<li>TODO：<a href="https://segmentfault.com/a/1190000015752512" target="_blank" rel="noopener">https://segmentfault.com/a/1190000015752512</a></li>
<li>TODO：<a href="https://segmentfault.com/a/1190000016447307" target="_blank" rel="noopener">https://segmentfault.com/a/1190000016447307</a></li>
</ul>
</li>
<li><code>Atomic*</code> &amp;&amp; <code>Atomic*FieldUpdater</code></li>
<li><code>Phaser</code>，<code>CyclicBarrier</code>，<code>CountDownLatch</code></li>
<li>CAS：<code>Unsafe.compareAndSwap*</code>（提供了硬件级别的CAS原子操作）<ul>
<li>todo: <a href="https://segmentfault.com/a/1190000016542779#item-3-6" target="_blank" rel="noopener">https://segmentfault.com/a/1190000016542779#item-3-6</a></li>
</ul>
</li>
<li><code>Object.wait</code>, <code>Object.notify</code></li>
<li>无锁方案<ul>
<li><code>ThreadLocal</code></li>
<li>不可变对象（Immutable Object）</li>
</ul>
</li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="伪共享（false-sharing）"><a href="#伪共享（false-sharing）" class="headerlink" title="伪共享（false sharing）"></a>伪共享（false sharing）</h3><ul>
<li><p><strong>定义</strong>：</p>
<ul>
<li>缓存系统中是以缓存行（cache line）为单位存储的，缓存行是2^n个连续字节，一般为32-256个字节，最常见的缓存行大小是64个字节</li>
<li>当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能（performance degradation when several threads are modifying independent variables sharing the same cache line）</li>
</ul>
</li>
<li><p><strong>举例</strong>：</p>
<ul>
<li>两个变量X、Y在同一个cache line。此时，Core1上的线程1更新变量X，同时Core2上的线程2更新变量Y，每个线程都要竞争缓存行的所有权（锁）来更新变量。如果Core1获得了锁，缓存系统将会使Core2中对应的缓存行失效；当Core2获得了锁，执行完成更新操作，Core1的缓存行就会失效。这会循环往复地经过L3缓存，极大影响性能。如果互相竞争的Core位于不同插槽，则性能影响更严重</li>
</ul>
</li>
<li><p><strong>解决思路</strong>：</p>
<ul>
<li>为了让可伸缩性与线程数呈线性关系，需要保证不会有两个线程往同一个变量或缓存行中写入</li>
<li>JDK7中，可以通过在属性的前后人为进行padding  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span> </span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">long</span> p0, p1, p2, p3, p4, p5, p6;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">long</span> q0, q1, q2, q3, q4, q5, q6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>JDK8中提供了<code>@sun.misc.Contended</code>注解<ul>
<li><strong>原理</strong>：在使用此注解的对象或字段的前后各增加128字节大小的padding（两倍于大多数硬件缓存行的大小）</li>
<li><strong>note</strong>: 需要显式设置JVM参数<code>-XX:-RestrictContended</code></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>源码级应用</strong>：        </p>
<ul>
<li><code>ForkJoinPool.WorkQueue</code>标注了上述注解，防止线程池中，各线程对应的<code>WorkQueue</code>因频繁操作出现伪共享问题</li>
</ul>
</li>
</ul>
<h3 id="Thread-Affinity"><a href="#Thread-Affinity" class="headerlink" title="Thread Affinity"></a>Thread Affinity</h3><p>thread affinity [todo <a href="https://blog.csdn.net/wangcg123/article/details/78551870]" target="_blank" rel="noopener">https://blog.csdn.net/wangcg123/article/details/78551870]</a></p>
<h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><p>[TODO ]</p>
<ul>
<li><code>ForkJoinPool</code><ul>
<li><a href="https://segmentfault.com/a/1190000008140126" target="_blank" rel="noopener">https://segmentfault.com/a/1190000008140126</a></li>
</ul>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://gee.cs.oswego.edu/dl/papers/fj.pdf" target="_blank" rel="noopener">A Java Fork/Join Framework - Doug Lea</a></li>
</ul>

<script type="text/javascript" src="/js/kity204.min.js"></script>
<script type="text/javascript" src="/js/kityminder1450.core.min.js"></script>
<script defer="true" type="text/javascript" src="/js/mindmap020.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/mindmap020.min.css">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dzhu.pro/2020/03/03/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="朱迪">
      <meta itemprop="description" content="Di Zhu, data architect, outdoor enthusiasts, introspectionist.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱迪">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/03/hello-world/" class="post-title-link" itemprop="url">个人记录</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-03 23:36:00" itemprop="dateCreated datePublished" datetime="2020-03-03T23:36:00+08:00">2020-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-23 10:46:34" itemprop="dateModified" datetime="2020-03-23T10:46:34+08:00">2020-03-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Management/" itemprop="url" rel="index"><span itemprop="name">Management</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote class="pullquote mindmap mindmap-md"><ul>
<li><a href="#pooki1e">Hexo 的思维导图插件</a><ul>
<li>前言1</li>
<li>使用方法1<ul>
<li>1一</li>
<li>1二</li>
<li>三1</li>
</ul>
</li>
<li>1太长不看1212313</li>
<li>参考1资料</li>
</ul>
</li>
</ul>
</blockquote>

<h3 id="分类："><a href="#分类：" class="headerlink" title="分类："></a>分类：</h3><ul>
<li>Management</li>
<li>Finance | Economics | Investment</li>
<li>CS</li>
</ul>
<h3 id="abc"><a href="#abc" class="headerlink" title="abc"></a>abc<a name="pooki1e"></a></h3>
<script type="text/javascript" src="/js/kity204.min.js"></script>
<script type="text/javascript" src="/js/kityminder1450.core.min.js"></script>
<script defer="true" type="text/javascript" src="/js/mindmap020.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/mindmap020.min.css">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Outlines
        </li>
        <li class="sidebar-nav-overview">
          Categories
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        
<!-- MARK: 修改了侧边栏overview内容，直接改为静态的分类（Categories）列表 -->
<nav class="site-nav">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a href="/categories/Finance-Economics-Investment/" rel="section"><i class="fa fa-fw fa-angle-right"></i>Finance | Economics | Investment</a>
    </li>
    <li class="menu-item">
      <a href="/categories/Management/" rel="section"><i class="fa fa-fw fa-angle-right"></i>Management</a>
    </li>
    <li class="menu-item">
      <a href="/categories/CS/" rel="section"><i class="fa fa-fw fa-angle-right"></i>CS</a>
    </li>
  </ul>
</nav>

<!--
<div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="朱迪"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">朱迪</p>
  <div class="site-description" itemprop="description">Di Zhu, data architect, outdoor enthusiasts, introspectionist.</div>
</div>


-->
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2006 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dzhu.pro</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>


<!-- MARK: add jquery js -->
<script src="/js/jquery-3.4.1.min.js"></script>

<!-- END -->
<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
